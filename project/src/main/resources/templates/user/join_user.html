<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layout/user_layout}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .btn-male,
        .btn-female {
            padding: 10px 10px;
            color: black;
            background-color: #EDEDED;
            cursor: pointer;
        }

        .btn-male.selected,
        .btn-female.selected {
            background-color: #007bff;
            color: white;
        }
    </style>
    <title>íšŒì› í˜ì´ì§€</title>
</head>

<body layout:fragment="content">
    <div class="wrap d-flex flex-column container-fluid container">
        <div class="main-content">
            <main>
                <form class="register-form" method="post" action="/user/join_user" onsubmit="return validateForm()">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100" fill="currentColor"
                        class="bi bi-person-check" viewBox="0 0 16 16">
                        <path
                            d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m1.679-4.493-1.335 2.226a.75.75 0 0 1-1.174.144l-.774-.773a.5.5 0 0 1 .708-.708l.547.548 1.17-1.951a.5.5 0 1 1 .858.514M11 5a3 3 0 1 1-6 0 3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4" />
                        <path
                            d="M8.256 14a4.5 4.5 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10q.39 0 .74.025c.226-.341.496-.65.804-.918Q8.844 9.002 8 9c-5 0-6 3-6 4s1 1 1 1z" />
                    </svg>

                    <h2 style="color:#787979; border-bottom:1px solid lightgrey; padding-bottom: 10px;">íšŒì›ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”
                    </h2>

                    <div for="username" class="userid">ì•„ì´ë””</div>

                    <div id="id">
                        <div class="check-btn">
                            <input type="text" class="username_input" name="userId" id="userId"
                                placeholder="4~20ìë¦¬/ì˜ë¬¸,ìˆ«ì,íŠ¹ìˆ˜ë¬¸ì '_'ì‚¬ìš©ê°€ëŠ¥" required onchange="validateId(this)" />

                            <button type="button" class="btn-male" id="" onclick="checkId()"
                                style="background-color: #007bff; color: white; margin-left: 15px;">ì¤‘ë³µ</button>

                            <img id="id_check_sucess" style="display: none;">
                        </div>
                    </div>
                    <br>

                    <div for="password" class="userpw" style="width: 84px; text-align: center;">ë¹„ë°€ë²ˆí˜¸</div>

                    <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ -->
                    <input type="password" id="password" name="userPw" placeholder="8~16ìë¦¬/ì˜ë¬¸ ëŒ€ì†Œë¬¸ì,ìˆ«ì,íŠ¹ìˆ˜ë¬¸ì ì¡°í•©" required
                        onchange="validatePasswordConfirmation()">

                    <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì…ë ¥ í•„ë“œ -->
                    <input type="password" id="confirm-password" name="pw_confirm" required placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                        onchange="validatePasswordConfirmation()">


                    <br>
                    <div for="phone" class="userphone">íœ´ëŒ€í°</div>

                    <div class="phone">
                        <input type="text" id="phone" name="userPhone" required placeholder="ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
                            onchange="validatePhone(this)">
                    </div>

                    <div for="name" class="username" style="width: 55px; text-align: center;">
                        ì´ë¦„
                    </div>

                    <div class="gender">
                        <input class="input-name" type="text" id="name" name="userName" required placeholder="ì´ë¦„">
                        <div class="gender-btn">

                            <input type="hidden" id="userGender" name="userGender">
                            <button type="button" class="btn-male" id="male" name="userGender"
                                onclick="change_btn(event)" value="ë‚¨ì">ë‚¨</button>
                            <button type="button" class="btn-female" id="female" name="userGender"
                                onclick="change_btn(event)" value="ì—¬ì">ì—¬</button>
                        </div>
                    </div>

                    <div for="birthdate" class="userbirth" style="width: 84px; text-align: center;">ìƒë…„ì›”ì¼</div>

                    <!-- ë‹¬ë ¥ ì½”ë“œ -->
                    <div class="birthdate">

                        <input type="date" id="startDate" name="userBirth" class="keyword-main">

                    </div>

                    <br>

                    <div for="email" class="useremail">
                        ì´ë©”ì¼
                    </div>
                    <div class="phone">
                        <div class="d-flex justify-content">
                            <!-- ì´ë©”ì¼ ì…ë ¥ íƒœê·¸-->
                            <input type="text" required placeholder="ì´ë©”ì¼" name="firstEmail" id="firstEmail"
                                style="height:45.6px;">

                            <svg xmlns="http://www.w3.org/2000/svg" width="80" height="72" fill="currentColor"
                                class="bi bi-at" viewBox="0 0 16 16" style="height:64.6px;">
                                <path
                                    d="M13.106 7.222c0-2.967-2.249-5.032-5.482-5.032-3.35 0-5.646 2.318-5.646 5.702 0 3.493 2.235 5.708 5.762 5.708.862 0 1.689-.123 2.304-.335v-.862c-.43.199-1.354.328-2.29.328-2.926 0-4.813-1.88-4.813-4.798 0-2.844 1.921-4.881 4.594-4.881 2.735 0 4.608 1.688 4.608 4.156 0 1.682-.554 2.769-1.416 2.769-.492 0-.772-.28-.772-.76V5.206H8.923v.834h-.11c-.266-.595-.881-.964-1.6-.964-1.4 0-2.378 1.162-2.378 2.823 0 1.737.957 2.906 2.379 2.906.8 0 1.415-.39 1.709-1.087h.11c.081.67.703 1.148 1.503 1.148 1.572 0 2.57-1.415 2.57-3.643zm-7.177.704c0-1.197.54-1.907 1.456-1.907.93 0 1.524.738 1.524 1.907S8.308 9.84 7.371 9.84c-.895 0-1.442-.725-1.442-1.914" />
                            </svg>
                            <select class="form-control" name="lastEmail" id="lastEmail" style="height:45.6px;">
                                <option value="gmail.com">gmail.com</option>
                                <option value="naver.com">naver.com</option>
                                <option value="daum.net">daum.net</option>
                            </select>
                            <input type="hidden" id="userEmail" name="userEmail">

                            <div class="justify-content-end">
                                <button type="button" class="btn-male"
                                    style="background-color: #007bff; color: white; margin-left:10px;"
                                    onclick="combineEmail()">ì¸ì¦</button>
                            </div>
                        </div>

                        <div id="passwordChange" class="d-flex flex-column" style="display: none !important;">
                            <div class="check-btn">
                                <input type="text" class="username_input" name="emailCode" id="emailCode"
                                    placeholder="ì´ë©”ì¼ ì¸ì¦ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" />
                                <button type="button" class="btn-male"
                                    style="background-color: #007bff; color: white; margin-left: 15px;"
                                    onclick="email_Code()">í™•ì¸</button>
                            </div>
                        </div>
                        <div class="d-grid gap-2" id="joinbutton" style="display: none !important;">
                            <button class="btn mt-4" type="submit"
                                style="background-color: var(--main-color); color: #fff; ">íšŒì›ê°€ì…</button>
                        </div>
                </form>
            </main>
        </div>
    </div>

    <script>
        // âœ… ì‚¬ìš©ìê°€ ì…ë ¥ì•ˆ ì½”ë“œë¥¼ dbì— ê²€ì‚¬í•˜ëŠ” í•¨ìˆ˜
        function email_Code() {
            var verificationCode = document.getElementById('emailCode').value;

            var csrfToken = "[[${_csrf.token}]]";
            let url = "/user/email_code_check";

            $.ajax({
                type: 'POST',
                url: url,
                data: JSON.stringify({
                    verificationCode: verificationCode
                }), // ë°ì´í„°ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
                contentType: 'application/json; charset=UTF-8', // ì „ì†¡ ë°ì´í„° íƒ€ì…ì„ JSONìœ¼ë¡œ ì„¤ì •
                dataType: 'text', // ì‘ë‹µ ë°ì´í„° íƒ€ì…ì„ í…ìŠ¤íŠ¸ë¡œ ì§€ì •
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);
                },
                // ìš”ì²­ ì„±ê³µ 
                success: function (response, status) {
                    // response : ì‘ë‹µ ë°ì´í„°
                    // status   : ì‘ë‹µ ìƒíƒœ

                    if (response === "ì„±ê³µ") {
                        alert('ì½”ë“œì¸ì¦ì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤.');
                        $('#joinbutton').css('display', 'flex');
                    } else {
                        alert('ì½”ë“œì¸ì¦ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.');
                    }
                },
                // ì—ëŸ¬
                error: function (xhr, status) {
                    // xhr      : XMLHttpRequest ê°ì²´
                    // status   : ì‘ë‹µ ìƒíƒœ
                    alert('ì„œë²„ì—ëŸ¬');
                }
            });
        }

        // âœ… ì´ë©”ì¼ í†µí•© í•˜ê³  ì´ë©”ì¼ì— ì½”ë“œë¥¼ ë³´ë‚´ëŠ” í•¨ìˆ˜ 
        function combineEmail() {
            var firstEmail = document.getElementById('firstEmail').value;
            var lastEmail = document.getElementById('lastEmail').value;
            var email = firstEmail + "@" + lastEmail;
            document.getElementById('userEmail').value = email;
            alert('ì´ë©”ì¼ í™•ì¸ì¤‘..');

            var csrfToken = "[[${_csrf.token}]]";
            let url = "/user/find_users";

            $.ajax({
                type: 'POST',
                url: url,
                data: email, // ì´ë©”ì¼ ì£¼ì†Œë¥¼ ë¬¸ìì—´ë¡œ ì „ì†¡
                contentType: 'text/plain', // ë°ì´í„°ì˜ íƒ€ì…ì„ ëª…ì‹œ
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);
                },
                // ìš”ì²­ ì„±ê³µ 
                success: function (response, status) {
                    // response : ì‘ë‹µ ë°ì´í„°
                    // status   : ì‘ë‹µ ìƒíƒœ
                    if (response === "1") {
                        alert('ì´ë©”ì¼ì—ì„œ ì¸ì¦ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        $('#passwordChange').css('display', 'flex');
                    } else {
                        alert('ì—ëŸ¬~!~!@~!@~!#!~#~!@~!@~!@~@!~@~@~!@');
                    }
                },
                // ì—ëŸ¬
                error: function (xhr, status) {
                    // xhr      : XMLHttpRequest ê°ì²´
                    // status   : ì‘ë‹µ ìƒíƒœ
                    alert('ì„œë²„ì—ëŸ¬');
                }
            });
        }
        // ğŸ’ CRSF TOKEN
        var csrfToken = "[[${_csrf.token}]]"

        // âœ… ë²„íŠ¼ í´ë¦­ì‹œ ìœ ì§€í•˜ëŠ” js ì½”ë“œ
        function change_btn(event) {
            var buttons = document.querySelectorAll('.gender-btn button');
            buttons.forEach(function (button) {
                button.classList.remove('selected');
            });

            var clickedButton = event.target;
            clickedButton.classList.add('selected');

            var gender = clickedButton.value;
            document.getElementById('userGender').value = gender;
        }

        // âœ… ì•„ì´ë”” ìœ íš¨ì„± ê²€ì‚¬
        function validateId(input) {
            var id = input.value;
            // 4~20ìë¦¬
            // ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì '_'ë§Œ ì‚¬ìš© ê°€ëŠ¥
            if (!/^[a-zA-Z0-9_]{4,20}$/.test(id)) {
                input.setCustomValidity("ì•„ì´ë””ëŠ” 4~20ìë¦¬ë¡œ ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì '_'ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            } else {
                input.setCustomValidity("");
            }

            // ìœ íš¨ì„± ê²€ì‚¬ ë©”ì‹œì§€ í‘œì‹œ
            input.reportValidity();
        }

        // âœ… ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„±ê²€ì‚¬
        function validatePasswordConfirmation() {
            var password = document.getElementsByName("userPw")[0].value;
            var confirmPassword = document.getElementsByName("pw_confirm")[0].value;

            // ë¹„ë°€ë²ˆí˜¸ê°€ 8~16ìë¦¬ì´ê³  ì˜ë¬¸ ëŒ€ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•˜ëŠ”ì§€ ê²€ì‚¬
            if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[~!@#$%^&*()_+`\-={}[\]:;"'<script>,.?\\/]).{8,16}$/.test(
                password)) {
                document.getElementsByName("userPw")[0].setCustomValidity(
                    "ë¹„ë°€ë²ˆí˜¸ëŠ” 8~16ìë¦¬ì˜ ì˜ë¬¸ ëŒ€ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.");
            } else {
                document.getElementsByName("userPw")[0].setCustomValidity("");
            }

            // ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì‚¬
            if (password !== confirmPassword) {
                document.getElementsByName("pw_confirm")[0].setCustomValidity("ë¹„ë°€ë²ˆí˜¸ì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            } else {
                document.getElementsByName("pw_confirm")[0].setCustomValidity("");
            }
        }


        // âœ… íšŒì›ê°€ì… í• ë•Œ ë§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸í•˜ëŠ” ìœ íš¨ì„± ê²€ì‚¬
        function validateForm() {
            var isValid = true;

            isValid = checkIdForm() && isValid; // ì•„ì´ë”” ì¤‘ë³µ ì²´í¬

            validatePasswordConfirmation(); // ë¹„ë°€ë²ˆí˜¸ í™•ì¸

            var usernameInput = document.querySelector('.username_input');
            validateId(usernameInput); // ì•„ì´ë”” ìœ íš¨ì„± ê²€ì‚¬

            var genderSelected = document.getElementById('userGender').value;

            if (genderSelected === '') { // ì„±ë³„ì´ ì„ íƒë˜ì§€ ì•Šì•˜ì„ ë•Œ
                alert('ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
                isValid = false; // í¼ ì œì¶œ ì¤‘ë‹¨
            }

            if (document.getElementsByName("pw_confirm")[0].checkValidity() === false) {
                document.getElementsByName("pw_confirm")[0].reportValidity(); // ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ì—¬ë¶€ ê²€ì‚¬
                isValid = false;
            }

            return isValid;
        }

        // âœ… íœ´ëŒ€ì „í™” ìœ íš¨ì„± ê²€ì‚¬
        function validatePhone(input) {
            var phone = input.value;
            // íœ´ëŒ€í° ë²ˆí˜¸ê°€ 11ìë¦¬ì¸ì§€ í™•ì¸
            if (phone.length !== 11 || !/^[0-9]+$/.test(phone)) {
                input.setCustomValidity("íœ´ëŒ€ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
            } else {
                input.setCustomValidity("");
            }
            // ìœ íš¨ì„± ê²€ì‚¬ ë©”ì‹œì§€ í‘œì‹œ
            input.reportValidity();
        }

        // âœ… ì²˜ìŒì— ì¸ì¦ë²„íŠ¼ ëˆŒë €ì„ë•Œ í•˜ëŠ” ìœ íš¨ì„± ê²€ì‚¬
        function checkId() {
            let userId = document.getElementById('userId').value
            let request = new XMLHttpRequest()

            request.open("GET", `/user/check/${userId}`, false) // ë™ê¸°ì  ìš”ì²­ìœ¼ë¡œ ë³€ê²½
            request.setRequestHeader("Content-Type", "application/json")
            request.setRequestHeader("X-CSRF-TOKEN", csrfToken)
            request.send()

            if (request.status === 200) {
                if (request.responseText === 'true') {
                    alert('ì‚¬ìš©ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.')
                    return true; // ì•„ì´ë”” ì¤‘ë³µ ì—†ìŒ
                } else {
                    alert('ì¤‘ë³µëœ ì•„ì´ë””ì…ë‹ˆë‹¤.')
                    return false; // ì•„ì´ë”” ì¤‘ë³µ ë°œê²¬
                }
            } else {
                alert('ì„œë²„ ì˜¤ë¥˜.')
                return false; // ì„œë²„ ì˜¤ë¥˜
            }
        }

        // âœ… ì¤‘ë³µì„ ê²€ì‚¬ ì•ˆí•˜ê³  ì œì¶œí• ë•Œ í•˜ëŠ” ìœ íš¨ì„± ê²€ì‚¬
        function checkIdForm() {
            let userId = document.getElementById('userId').value
            let request = new XMLHttpRequest()

            request.open("GET", `/user/check/${userId}`, false) // ë™ê¸°ì  ìš”ì²­ìœ¼ë¡œ ë³€ê²½
            request.setRequestHeader("Content-Type", "application/json")
            request.setRequestHeader("X-CSRF-TOKEN", csrfToken)
            request.send()

            if (request.status === 200) {
                if (request.responseText === 'true') {

                    return true; // ì•„ì´ë”” ì¤‘ë³µ ì—†ìŒ
                } else {
                    alert('ì¤‘ë³µëœ ì•„ì´ë””ì…ë‹ˆë‹¤.')
                    return false; // ì•„ì´ë”” ì¤‘ë³µ ë°œê²¬
                }
            } else {
                alert('ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.')
                return false; // ì„œë²„ ì˜¤ë¥˜
            }
        }

        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('error') && urlParams.get('error') === 'emailExists') {
                alert('ì´ë¯¸ ê°€ì…í•œ ì´ë©”ì¼ì´ ìˆìŠµë‹ˆë‹¤');
            }
        };
    </script>
</body>

</html>