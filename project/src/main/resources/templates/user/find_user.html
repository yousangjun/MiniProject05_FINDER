<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{/layout/user_layout}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Finder ID/Password Recovery</title>
</head>

<body layout:fragment="content">

  <div class="container recovery-form" style="width: 45%;">
    <div class="form-header">
      <h4 style="margin-top: 10px;">íšŒì› ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ìŠµë‹ˆê¹Œ?</h4>
      <p>ì•„ì´ë”” ì°¾ê¸°ì™€ ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° ì¤‘ í•´ë‹¹ë˜ëŠ” ê²ƒì— ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
    </div>
    <div class="row mt-4">
      <div class="d-flex justify-content-center w-100">
        <div class="col-6">
          <h4><strong>ì•„ì´ë”” ì°¾ê¸°</strong></h4>

          <form action="/user/find_user" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <div class="form-group">
              <label for="email" style="margin-top: 20px;"><strong>ì´ë©”ì¼</strong></label>
              <div class="d-flex">
                <!-- ì´ë©”ì¼ ì…ë ¥ íƒœê·¸ -->
                <input type="text" class="form-control" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." name="firstEmail" id="firstEmail">

                <span class="mx-2">@</span>
                <select class="form-control" name="lastEmail" id="lastEmail">
                  <option value="gmail.com">gmail.com</option>
                  <option value="naver.com">naver.com</option>
                  <option value="daum.net">daum.net</option>
                </select>
                <input type="hidden" id="userEmail" name="userEmail">
              </div>
            </div>
            <div class="form-group" style="margin-top: 10px;">
              <label for="username"><strong>ì‚¬ìš©ìëª…</strong></label>
              <div class="d-flex justify-content-between">
                <!-- ì‚¬ìš©ìëª… ì…ë ¥íƒœê·¸ -->
                <input type="text" class="form-control" id="username" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." name="userName">

                <button type="submit" class="btn btn-primary" style="width: 16% !important; margin-left: 15px;"
                  onclick="combineEmail()">í™•ì¸</button>
              </div>
            </div>
          </form>

        </div>

        <div class="divider"></div>

        <div class="col-6">
          <h4><strong>ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</strong></h4>
          <form action="/user/update_pw" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <div class="form-group">
              <label for="user-id" style="margin-top: 20px;"><strong>ì•„ì´ë””</strong></label>

              <!-- ì•„ì´ë”” ì…ë ¥ -->
              <input type="text" class="form-control" id="userId" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." name="userId">

            </div>
            <div class="form-group" style="margin-top: 10px;">
              <label for="email"><strong>ì´ë©”ì¼</strong></label>
              <div class="d-flex">

                <!-- ì´ë©”ì¼ ì…ë ¥ -->
                <input type="text" class="form-control" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." name="firstEmail" id="firstEmail2">

                <span class="mx-2">@</span>
                <select class="form-control" name="lastEmail" id="lastEmail2">
                  <option value="gmail.com">gmail.com</option>
                  <option value="naver.com">naver.com</option>
                  <option value="daum.net">daum.net</option>
                </select>
                <input type="hidden" id="userEmail2" name="userEmail">
              </div>
            </div>
            <div class="form-group" style="margin-top: 10px;">
              <label for="username"><strong>ì‚¬ìš©ìëª…</strong></label>
              <div class="d-flex justify-content-between">

                <!-- ì‚¬ìš©ìëª… ì…ë ¥ -->
                <input type="text" class="form-control" id="userName" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.">

                <button type="button" class="btn btn-primary" style="width: 16% !important; margin-left: 15px;"
                  onclick="PW_Confirm()">í™•ì¸</button>
              </div>
              <!-- ì •ë³´ê°€ ì¼ì¹˜í•˜ë©´ ë‚˜ì˜¤ëŠ” input íƒœê·¸ -->
              <div id="passwordChange" class="d-flex flex-column" style="display: none !important;">
                <input type="password" id="userPw" name="userPw" class="form-control"
                  placeholder="8~16ìë¦¬/ì˜ë¬¸ ëŒ€ì†Œë¬¸ì,ìˆ«ì,íŠ¹ìˆ˜ë¬¸ì ì¡°í•©" required style="margin-top: 10px;">
                <input type="password" id="confirm-password" name="confirm-password" class="form-control" required
                  placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" style="margin-top: 10px;">
                <div class=" d-flex justify-content-end">
                  <button onclick="validatePasswordConfirmation()" id="UpdatePw" type="submit" class="btn btn-primary"
                    style="width: 16% !important; margin-left: 15px; margin-top: 10px;">ë³€ê²½</button>
                </div>
                <br>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="alert alert-primary mt-4" role="alert">
      ê³ ê°ë‹˜ê»˜ì„œ ê²€ìƒ‰í•˜ì‹  ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ëŠ” ì´ë©”ì¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.
      <p>ì•„ì´ë””ëŠ” ì´ë©”ì¼ê³¼ ì‚¬ìš©ìëª…ì´ ë§ì•„ì•¼ ì „ì†¡ë©ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ëŠ” ì•„ì´ë””/ì´ë©”ì¼/ì‚¬ìš©ìëª… ëª¨ë‘ ë§ì•„ì•¼ ì „ì†¡ë©ë‹ˆë‹¤.</p>
    </div>
  </div>

  <script>
    // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    function PW_Confirm() {

      var firstEmail = document.getElementById('firstEmail2').value;
      var lastEmail = document.getElementById('lastEmail2').value;
      var userEmail = firstEmail + "@" + lastEmail;
      document.getElementById('userEmail2').value = userEmail;

      // ğŸ’ CSRF TOKEN    
      var csrfToken = "[[${_csrf.token}]]";
      let url = "/user/info_check";
      var userId = document.getElementById('userId').value;
      // var userEmail = document.getElementById('userEmail2').value;
      var userName = document.getElementById('userName').value;

      // jQuery ë¡œ AJAX ìš”ì²­
      $.ajax({
        type: 'POST', // ìš”ì²­ ë©”ì†Œë“œ - GET, POST, PUT, DELETE
        url: url, // ìš”ì²­ URL
        data: JSON.stringify({ // ìš”ì²­ ë°ì´í„°ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
          id: userId,
          email: userEmail,
          name: userName
        }),
        contentType: 'application/json', // ìš”ì²­ ë°ì´í„° íƒ€ì…
        dataType: 'json', // ì‘ë‹µ ë°ì´í„° íƒ€ì…
        beforeSend: function (xhr) {
          // ğŸ’ CSRF í† í°ì„ ìš”ì²­ í—¤ë”ì— ì¶”ê°€
          xhr.setRequestHeader('X-CSRF-TOKEN', csrfToken);
        },
        // ìš”ì²­ ì„±ê³µ 
        success: function (response, status) {
          // response : ì‘ë‹µ ë°ì´í„°
          // status   : ì‘ë‹µ ìƒíƒœ
          if (response) {
            alert('ì‚¬ìš©ì ì •ë³´ë‘ ì¼ì¹˜í•©ë‹ˆë‹¤.');
            $('#passwordChange').css('display', 'flex') // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ í›„ ë³€ê²½ í¼ ë³´ì—¬ì£¼ê¸°
          } else {
            alert('ì…ë ¥í•˜ì‹  ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
            $('#passwordChange').css('display', 'none !important')
          }
        },
        // ì—ëŸ¬
        error: function (xhr, status) {
          // xhr      : XMLHttpRequest ê°ì²´
          // status   : ì‘ë‹µ ìƒíƒœ
          alert('ì—ëŸ¬ ë°œìƒ');
        }
      });
    }

    // ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬ â­•
    function validatePasswordConfirmation() {

      var password = document.getElementsByName("userPw")[0].value;
      var confirmPassword = document.getElementsByName("confirm-password")[0].value;
      var UpdatePw = $('#UpdatePw');
      console.log(password + "+" + confirmPassword)

      // ë¹„ë°€ë²ˆí˜¸ê°€ 8~16ìë¦¬ì´ê³  ì˜ë¬¸ ëŒ€ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•˜ëŠ”ì§€ ê²€ì‚¬
      if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[~!@#$%^&*()_+`\-={}[\]:;"'<>,.?\\/]).{8,16}$/.test(password)) {
        document.getElementsByName("userPw")[0].setCustomValidity(
          "ë¹„ë°€ë²ˆí˜¸ëŠ” 8~16ìë¦¬ì˜ ì˜ë¬¸ ëŒ€ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ ëª¨ë‘ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.");
      } else {
        document.getElementsByName("userPw")[0].setCustomValidity("");


        // ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì‚¬
        if (password != confirmPassword) {
          document.getElementsByName("confirm-password")[0].setCustomValidity("ë¹„ë°€ë²ˆí˜¸ì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return
        } else {
          document.getElementsByName("confirm-password")[0].setCustomValidity("");
          alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.') // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ
        }
      }
    }

    function combineEmail() {
      var firstEmail = document.getElementById('firstEmail').value;
      var lastEmail = document.getElementById('lastEmail').value;
      var userEmail = firstEmail + "@" + lastEmail;
      document.getElementById('userEmail').value = userEmail;
    }
  </script>
</body>

</html>